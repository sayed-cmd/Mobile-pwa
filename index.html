<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Browser to Mobile Call</title>
  <style>
    body { font-family:"Segoe UI", Roboto, Arial, sans-serif; background:#f8fafc; margin:0; padding:0; color:#1e293b; }
    .container { max-width:500px; margin:40px auto; background:white; padding:24px; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
    h2 { text-align:center; }
    label { display:block; margin-bottom:6px; font-weight:500; }
    input[type="text"] { width:100%; padding:12px; font-size:15px; border:1px solid #cbd5e1; border-radius:8px; outline:none; transition:border 0.2s; }
    input[type="text"]:focus { border-color:#0b84ff; box-shadow:0 0 0 3px rgba(11,132,255,0.2); }
    .btn { padding:10px 16px; border-radius:8px; border:none; cursor:pointer; transition:all 0.2s; font-size:15px; }
    .btn-primary { background:#0b84ff; color:white; }
    .btn-primary:hover { background:#056ed8; }
    .btn-secondary { background:#ff1b1b; color:white; }
    .btn-secondary:disabled { opacity:0.6; cursor:not-allowed; }
    .btn-group { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:12px; }
    #status { margin-top:12px; font-size:14px; padding:8px 12px; background:#f1f5f9; border-radius:6px; text-align:center; }
    #number { font-size:20px; font-weight:600; margin-top:18px; text-align:center; }
    #callBtn-container { text-align:center; margin-top:16px; }
    #callBtn { display:inline-block; padding:12px 20px; border-radius:10px; font-size:16px; font-weight:500; text-decoration:none; background:#16a34a; color:white; transition:background 0.2s; }
    #callBtn:hover { background:#15803d; }
    .debug { margin-top:20px; }
    pre { background:#0f172a; color:#e2e8f0; padding:12px; border-radius:8px; overflow:auto; max-height:180px; font-size:13px; }
    #qr-reader { width: 100%; max-width:400px; height:300px; margin:10px auto; display:none; border:1px solid #cbd5e1; border-radius:8px; background:#f1f5f9; }
  </style>
</head>
<body>
<div class="container">
  <h2>üìû Browser to Mobile Call</h2>

  <label for="uidInput">UID</label>
  <input id="uidInput" type="text" placeholder="Scan QR or paste UID..." />

  <div class="btn-group">
    <button id="scanQR" class="btn btn-primary">üì∑ Scan QR</button>
    <button id="changeUID" class="btn btn-secondary" style="background:#f59e0b;">üîÑ Change UID</button>
  </div>

  <div class="btn-group">
    <button id="startBtn" class="btn btn-primary">‚ñ∂ Start</button>
    <button id="stopBtn" class="btn btn-secondary" disabled>‚èπ Stop</button>
  </div>

  <div id="qr-reader"></div>

  <div id="status">Status: not connected</div>
  <div id="number">Waiting for number...</div>

  <div id="callBtn-container">
    <a id="callBtn" href="#" style="display:none;">üì≤ Tap to Call</a>
  </div>

  <div class="debug">
    <strong>Console Log</strong>
    <pre id="log"></pre>
  </div>
</div>

<!-- Firebase SDK -->
<script src="libs/firebase-app-compat.js"></script>
<script src="libs/firebase-database-compat.js"></script>

<!-- QR Scanner -->
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

<script>
window.addEventListener('DOMContentLoaded', () => {
  // Firebase init
  const firebaseConfig = {
    apiKey: "AIzaSyAKTNMVnl4W04_WH0PqsIA2xattjTR6x0M",
    authDomain: "call-from-browserss.firebaseapp.com",
    databaseURL: "https://call-from-browserss-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "call-from-browserss",
    storageBucket: "call-from-browserss.firebasestorage.app",
    messagingSenderId: "421459301855",
    appId: "1:421459301855:web:5f9581250da6cd3935a06a"
  };
  try { firebase.initializeApp(firebaseConfig); } catch(e){}
  const db = firebase.database();

  // DOM Elements
  const uidInput = document.getElementById('uidInput');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const scanQRBtn = document.getElementById('scanQR');
  const changeUIDBtn = document.getElementById('changeUID');
  const statusEl = document.getElementById('status');
  const numberDiv = document.getElementById('number');
  const callBtn = document.getElementById('callBtn');
  const logEl = document.getElementById('log');
  const qrReader = document.getElementById('qr-reader');

  let currentUID = null;
  let callRef = null;
  let html5QrCode = null;
  let qrScanning = false;

  function log(msg){
    const t = new Date().toLocaleTimeString();
    logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
    if(logEl.textContent.length>6000) logEl.textContent=logEl.textContent.slice(0,6000);
  }

  function setStatus(text,color='#333'){ statusEl.textContent=`Status: ${text}`; statusEl.style.color=color; }

  function attachListenerForUID(uid){
    if(!uid) return;
    try{ if(callRef) callRef.off(); } catch(e){}
    callRef = db.ref(`calls/${uid}`);
    currentUID = uid;
    setStatus('Connected','green');
    startBtn.disabled=true; stopBtn.disabled=false;
    log(`Listening for calls/${uid}`);
    callRef.on('value', snap=>{
      const data = snap.val();
      if(data && data.number){
        numberDiv.textContent=`Number: ${data.number}`;
        callBtn.href=`tel:${data.number}`;
        callBtn.textContent=`üì≤ Tap to Call ${data.number}`;
        callBtn.style.display='inline-block';
        log(`Received number ${data.number}`);
      } else{
        numberDiv.textContent='Waiting for number...';
        callBtn.style.display='none';
      }
    });
  }

  function stopListener(){
    if(callRef) try{ callRef.off(); } catch(e){}
    currentUID=null;
    setStatus('Not connected','#333');
    numberDiv.textContent='Waiting for number...';
    callBtn.style.display='none';
    startBtn.disabled=false; stopBtn.disabled=true;
    log('Listener stopped');

    if(qrScanning && html5QrCode){
      html5QrCode.stop().then(()=>{
        try{ html5QrCode.clear(); } catch(e){}
        qrReader.style.display='none';
        scanQRBtn.textContent="üì∑ Scan QR";
        qrScanning=false;
      });
    }
  }

  function startListening(uid){
    if(!uid){ alert('Please scan QR or enter UID.'); return; }
    attachListenerForUID(uid);
    localStorage.setItem('savedUID',uid);
  }

  startBtn.addEventListener('click',()=>{ startListening(uidInput.value.trim()); });
  stopBtn.addEventListener('click',()=>stopListener());

  changeUIDBtn.addEventListener('click',()=>{
    localStorage.removeItem('savedUID');
    uidInput.value='';
    stopListener();
    log('Old UID cleared.');
    alert('Previous UID cleared. Scan or paste a new UID.');
  });

  uidInput.addEventListener('change',()=>{
    const uid=uidInput.value.trim();
    if(uid){ log(`Manual UID entered: ${uid}`); startListening(uid); }
  });

  scanQRBtn.addEventListener('click', async ()=>{
    if(qrScanning && html5QrCode){
      await html5QrCode.stop();
      try{ html5QrCode.clear(); } catch(e){}
      qrReader.style.display='none';
      qrScanning=false;
      scanQRBtn.textContent="üì∑ Scan QR";
      log('QR scanner closed by user');
      return;
    }

    qrReader.style.display='block';
    if(!html5QrCode) html5QrCode=new Html5Qrcode("qr-reader");

    try{
      qrScanning=true;
      await html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250}, onScanSuccess);
      scanQRBtn.textContent
